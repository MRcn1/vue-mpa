const fs = require('fs');
const glob = require('glob')
const path = require('path');
const endOfLine = require('os').EOL;
const render = require('json-templater/string');
const camelcase = require('camelcase');
const dayjs = require("dayjs");
/*扩展时间对象*/
Date.prototype.Format = function (formatStr) {
  return dayjs().format(formatStr);
};

/*输出目录*/
const OUTPUT_PATH = path.resolve(__dirname, '../src/components/basicUI/index.js');

let basePath = './src/components/basicUI/',
  globResult = glob.sync(basePath+'**/*.vue'),
  importList = [],
  componentNameList = [];

/*提取 import 路径和所有的component名称*/
globResult.forEach(function (curPath) {
  let pathInfo = path.parse(curPath),
    componentName = camelcase('qwui_'+pathInfo.name,{pascalCase: false}),
    importPath = curPath.replace(/\S*components\//,'@/components/');

  importList.push('import '+componentName+' from \''+importPath+'\';');
  componentNameList.push(componentName);
});


/*文件字符串模板*/
const MAIN_TEMPLATE = `/**************************************************************
 * Please don't edit this file
 * Automatically generated by './build/build-components-list.js'
 * buildTime:{{buildTime}}
 *************************************************************/

{{include}}

export default {
  {{list}}
};

`;

/*渲染模板生产文件*/
let template = render(MAIN_TEMPLATE, {
  include: importList.join(endOfLine),
  list: componentNameList.join(',' + endOfLine+'  '),
  buildTime:new Date().Format('YYYY-MM-DD HH:mm:ss')
});

fs.writeFileSync(OUTPUT_PATH, template);
console.log('[build entry] DONE:', OUTPUT_PATH);

